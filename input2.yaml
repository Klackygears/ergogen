meta:
  engine: 4.0.4
  name: archaeoptereeks
  version: 0.1
  ref: &kb_ref "Archaeoptereeks"
  author: klackygears
#  url: &kb_url null
  footprint: &switch_footprint "choc"
  switch:
    $extends: presets.choc

presets:
  # These presets provide different layout options
  # Select a preset in the `units` section below
  # Note: The appropriate switch footprint will still need to be set in the `pcb` section
  choc:
    # Key and keycap measures
    kx: cx # spacing between key centers (X-axis)
    ky: cy # spacing between key centers (Y-axis)
    ks: 18.5 # horizontal space between columns (default: 19)
    kp: 17.5 # vertical padding between keys (deafult: 19)
    kcow: 13.8 # key cutout hole width (cherry, choc v2: 14, choc v1: 13.8)
    kcoh: 13.8 # key cutout hole height (cherry, choc v2: 14, choc v1: 13.8)
    keycw: 17.5 # keycap width (cherry: 18, choc: 17.5)
    keych: 16.5 # keycap height (cherry: 18, choc: 16.5)
    led_pos_x: 0 # Led X position relative to the switch center
    led_pos_y: 4.7 # Led Y position relative to the switch center
    led_rotation: 0 # Led rotation
    vertical_underglow_shift: -kp + 7.8  # How much to shift underglow leds tied to keys
    vertical_diode_shift: 1.5 # How much to shift to avoid overlap
    horizontal_diode_shift: -0.5 kcow - 0.85
    diode_rotation: -180 # Diode rotation
    switch_rotation: 180 # Hotswap south, led north
  
units:
  $extends: meta.switch
  kx: cx
  ky: cy
  px: kx + 2
  py: ky + 2

  
  # Physical measures
  screw_radius: 1.1 # M2 screws
  screw_diameter: screw_radius * 2
  spacer_radius: 2.15 # M2 standoffs
  spacer_diameter: spacer_radius * 2
  fillet_radius: 0.5
  pwr_trace_width: 0.25
  gnd_trace_width: 0.25
  signal_trace_width: 0.15
  via_size: 0.56 # JLCPCB min 0.56 | KiCad default 0.8
  via_drill: 0.3 # JLCPCB min 0.3 | KiCad default 0.4

points:
  zones:
    matrix:
      key:
        tags: 
          - key
          - matrix_key
      anchor:
        rotate: 8
        shift: [125, -125] # Fix KiCad placement
      columns:
        pinky:
          key:
            column_net: DAT
            mirror.column_net: P10
          rows:
            bottom.key:
              led_prev: LED_3
              led_next: LED_4
            home.key:
              led_prev: LED_2
              led_next: LED_3
            top.key:
              led_prev: LED_1
              led_next: LED_2
        ring:
          key:
            splay: -10
          # hinge at the bottom right corner
          # of the bottom pinky's 14x14 hole
          # for historical reasons...
            origin: [-12, -19]
            stagger: 18
            column_net: SDA
            mirror.column_net: C0
          rows:
            bottom.key:
              led_prev: LED_4
              led_next: LED_5
            home.key:
              led_prev: LED_5
              led_next: LED_6
            top.key:
              led_prev: LED_6
              led_next: LED_7
        middle:
          key:
            splay: -5
            origin: [-12, -19]
            stagger: 14
            column_net: SLC
            mirror.column_net: C1
          rows:
            bottom.key:
              led_prev: LED_9
              led_next: LED_10
            home.key:
              led_prev: LED_8
              led_next: LED_9
            top.key:
              led_prev: LED_7
              led_next: LED_8
        index:
          key:
            splay: -5
            origin: [-12, -19]
            stagger: -10
            column_net: CS
            mirror.column_net: C2
          rows:
            bottom.key:
              led_prev: LED_12
              led_next: LED_13
            home.key:
              led_prev: LED_12
              led_next: LED_11
            top.key:
              led_prev: LED_11
              led_next: LED_10
        inner:
          key:
            stagger: -2
            column_net: R0
            mirror.column_net: C3
          rows:
            bottom.key:
              led_prev: LED_13
              led_next: LED_14
            home.key:
              led_prev: LED_14
              led_next: LED_15
            top.key:
              led_prev: LED_16
              led_next: LED_17
      rows:
        bottom:
          row_net: R1
        home:
          row_net: R2
        top:
          row_net: R3

    thumbfan:
      key:
        tags: 
          - key
          - thumb_key
      anchor:
        ref: matrix_inner_bottom
        shift: [-4, -19]
      columns:
        near:
          key:
            column_net: SDA
            mirror.column_net: C4
          rows:
            thumb.key:
              led_prev: LED_19
              led_next: LED_20
        home:
          key:
            spread: 19
            splay: -18
            origin: [-11, -9]
            column_net: SLC
            mirror.column_net: C5
          rows:
            thumb.key:
              led_prev: LED_19
              led_next: LED_20
        far:
          key:
            spread: 19
            splay: -18
            origin: [-10.5, -9]
            column_net: CS
            mirror.column_net: P16
          rows:
            thumb.key:
              led_prev: LED_22
              led_next: LED_23
      rows:
        thumb:
          row_net: P9

    thumbfan2:
      key:
        tags: 
          - key
          - thumb2_key
      anchor:
        ref: matrix_inner_bottom
        shift: [20, 1]
      columns:
        home:
          key:
            spread: 
            splay: -18
            origin: [-16, -13]
            column_net: R0
            mirror.column_net: P10
          rows:
            thumb.key:
              led_prev: LED_24
              led_next: ULED_6
      rows:
        thumb:
          row_net: P9
  rotate: -20
  mirror:
    ref: matrix_pinky_home
    distance: 216

outlines:
  raw:
    - what: rectangle
      where: true
      bound: true
      size: [kx+5, ky+5]
  keys:
    - what: rectangle
      where: true
      bound: false
      size: [kx-0.5,ky-0.5]
  board:
    - what: polygon
      operation: stack
      points:
          #left side
        - ref: matrix_pinky_top
          shift: [-.8kx,.8ky]
        - ref: matrix_pinky_bottom
          shift: [-.8kx,-.8ky]
        - ref: matrix_pinky_bottom
          shift: [.8kx,-.8ky]

          #bottom
        - ref: thumbfan_home_thumb
          shift: [-.4kx,-.8ky]
        - ref: thumbfan_home_thumb
          shift: [.4kx,-.8ky]
        - ref: thumbfan_far_thumb
          shift: [.7kx,-.8ky]
        - ref: mirror_thumbfan_far_thumb
          shift: [.7kx,-.8ky]
        - ref: mirror_thumbfan_home_thumb
          shift: [.4kx,-.8ky]
        - ref: mirror_thumbfan_home_thumb
          shift: [-.4kx,-.8ky]
          
          #right side
        - ref: mirror_matrix_pinky_bottom
          shift: [.8kx,-.8ky]
        - ref: mirror_matrix_pinky_bottom
          shift: [-.8kx,-.8ky]
        - ref: mirror_matrix_pinky_top
          shift: [-.8kx,.8ky]

          #right top
        - ref: mirror_matrix_ring_top
          shift: [-.8kx,.8ky]
        - ref: mirror_matrix_middle_top
          shift: [-.8kx,.8ky]
        - ref: mirror_matrix_middle_top
          shift: [.2kx,.8ky]
        - ref: mirror_matrix_middle_top
          shift: [.9kx,1.4ky]
          
          #mcu
        - ref: matrix_index_top
          shift: [kx,56]
        - ref: matrix_index_top
          shift: [-12,48]
        #- ref: matrix_index_top
        #  shift: [-12,40]
        #- ref: matrix_index_top
        #  shift: [0,40]
        #- ref: matrix_index_top
        #  shift: [0,30]
        #- ref: matrix_index_top
        #  shift: [-12,30]

          #left top
        - ref: matrix_middle_top
          shift: [.78kx,.8ky]
        - ref: matrix_middle_top
          shift: [-.8kx,.8ky]
        - ref: matrix_ring_top
          shift: [-.8kx,.8ky]

      fillet: 2
pcbs:
  base:
    outlines:
      main:
        outline: board
    footprints: 
      key_switches:
        what: choc
        where: true
        params:
          keycaps: false
          reverse: [false,true]
          hotswap: false
          from: "{{column_net}}"
          to: "{{colrow}}"
        adjust:
          rotate: 180
          
      diode:
        what: diode
        where: [matrix_pinky_top, matrix_pinky_home, matrix_pinky_bottom, matrix_ring_top, matrix_ring_home, matrix_ring_bottom, matrix_middle_top, matrix_middle_home, matrix_middle_bottom, matrix_index_top, matrix_index_home, matrix_index_bottom, matrix_inner_top, matrix_inner_home, matrix_inner_bottom, thumbfan_near_thumb, thumbfan_home_thumb, thumbfan_far_thumb, thumbfan2_home_thumb] 
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
        adjust:
          rotate: 90
          shift: [9,-1]

      diode_mirror:
        what: diode
        where: [mirror_matrix_pinky_top, mirror_matrix_pinky_home, mirror_matrix_pinky_bottom, mirror_matrix_ring_top, mirror_matrix_ring_home, mirror_matrix_ring_bottom, mirror_matrix_middle_top, mirror_matrix_middle_home, mirror_matrix_middle_bottom, mirror_matrix_index_top, mirror_matrix_index_home, mirror_matrix_index_bottom, mirror_matrix_inner_top, mirror_matrix_inner_home, mirror_matrix_inner_bottom, mirror_thumbfan_near_thumb, mirror_thumbfan_home_thumb, mirror_thumbfan_far_thumb, mirror_thumbfan2_home_thumb] 
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
        adjust:
          rotate: -90
          shift: [9,-1]

      mcu:
        what: nice_nano_rot
        where: matrix_inner_top
        params:
          P0: DAT
          P1: LED
          P21: C0
          P20: C1
          P19: C2
          P18: C3
          P15: C4
          P14: C5
          P2: SDA
          P3: SCL
          P4: CS
          P5: R0
          P6: R1
          P7: R2
          P8: R3
          traces: true
          show_instructions: false
          show_silk_labels: true
          show_via_labels: false
        adjust:
          shift: [-14.5,38]
          rotate: 90


      reset:
        what: button
        params:
          from: GND
          to: RST
          side: 'F'
        where:
          ref.aggregate.parts: [matrix_index_top]
          shift: [20,51]
          rotate: 0

      reset_b:
        what: button
        params:
          from: GND
          to: RST
          side: 'B'
        where:
          ref.aggregate.parts: [matrix_index_top]
          shift: [20,51]
          rotate: 0

      per_key_leds:
        what: sk6812minie
        where: /key/
        params:
          P1: VCC
          P2: "{{key.led_next}}" #DOUT
          P3: GND
          P4: "{{key.led_prev}}" #DIN
          reversible: true
          reverse_mount: true
          add_traces_vias: true
          add_keepout: false
          add_courtyard: false
          gnd_trace_width: gnd_trace_width
          pwr_trace_width: pwr_trace_width
          signal_trace_width: signal_trace_width
          via_size: via_size
          via_drill: via_drill
        adjust:
          shift: [led_pos_x, led_pos_y]
          rotate: led_rotation
